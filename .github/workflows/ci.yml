- name: Cache Foundry
  uses: actions/cache@v4
  with:
    path: |
      ~/.foundry
      ~/.cache/foundry
    key: ${{ runner.os }}-foundry-${{ hashFiles('**/foundry.toml') }}

- name: Install Foundry (forge + cast)
  run: |
    curl -L https://foundry.paradigm.xyz | bash
    foundryup
  env:
    FOUNDRY_SKIP_PROMPT: "1"

- name: Add Foundry to PATH
  run: echo "$HOME/.foundry/bin" >> $GITHUB_PATH

- name: Ensure solc is available
  run: |
    sudo apt-get update
    sudo apt-get install -y software-properties-common
    sudo add-apt-repository -y ppa:ethereum/ethereum
    sudo apt-get update
    sudo apt-get install -y solc

- name: Setup Python & install Slither
  run: |
    python3 -m pip install --upgrade pip
    pip3 install slither-analyzer

- name: Install repo dependencies (optional)
  run: |
    if [ -f foundry.toml ]; then
      forge install || true
    fi

- name: Run forge tests (JSON)
  run: |
    forge test --json > forge-test.json

- name: Run Slither (JSON + SARIF)
  run: |
    slither ./src --json slither.json --sarif slither.sarif || true

- name: Upload artifacts (reports)
  uses: actions/upload-artifact@v4
  with:
    name: security-and-test-reports
    path: |
      forge-test.json
      slither.json
      slither.sarif

- name: Upload SARIF to GitHub (code scanning)
  uses: github/codeql-action/upload-sarif@v2
  with:
    sarif_file: slither.sarif
